<!DOCTYPE HTML>
<html>
<head>
  <title>Dot Stuff</title>
  <style>
    body {    
    margin: 0;
    padding: 0;
	}
	
	table, th, td {
    border: 1px solid black;
    border-collapse: collapse;
	}
  </style>

</head>
 <script src="https://code.jquery.com/jquery-2.1.3.min.js"></script>
 <script src="https://cdnjs.cloudflare.com/ajax/libs/dat-gui/0.5/dat.gui.min.js"></script>

<body style="width:100%;height:100%;overflow:hidden;">
	<canvas id="draw"></canvas>
</body>

<script>

	/**
	 * Returns a random integer between min (inclusive) and max (inclusive)
	 * Using Math.round() will give you a non-uniform distribution!
	 */
	function getRandomInt(min, max) {
	    return Math.floor(Math.random() * (max - min + 1)) + min;
	}

	function ArrayList(){
		this.array = [];
		this.length = 0;
		
		this.add = function(ob){
			this.array[this.length] = ob;
			this.length ++;
		}
		
		this.index = function(ob){
			return this.array.indexOf(ob);
		}
		
		this.remove = function(ob){
			for(var i = this.array.indexOf(ob); i < this.length - 1; i++){
				this.array[i] = this.array[i + 1];
			}
			
			this.length --;
		}
		
		this.get = function(ind){
			return this.array[ind];
		}
		
		this.render = function(g){
			var count = 0;
			var totspeed = 0;
			var totaccel = 0;
			var totlifes = 0;
		
			for(var i = 0; i < this.length; i ++){
				if(this.array[i].type == "Player"){
					var cur = this.array[i];
					
					g.fillStyle = cur.color;
					g.fillText((cur.speed).toFixed(3) + "    " + (cur.accel).toFixed(3) + "    " + (cur.lifespan).toFixed(3), 20, 40 + (20 * count));
					
					totspeed += cur.speed;
					totaccel += cur.accel;
					totlifes += cur.lifespan;
					count ++;
				}
			}
			
			g.fillStyle = "#101010";
			g.fillText((totspeed / count).toFixed(3) + "    " + (totaccel / count).toFixed(3) + "    " + (totlifes / count).toFixed(3), 20, 20);
		}
	}
	
	function Point(x, y){
		this.y = y;
		this.x = x;
		
		this.mag = function(){
			return Math.sqrt(Math.pow(x, 2) + Math.pow(y, 2));
		}
		
		this.add = function(p){
			return new Point(this.x + p.x, this.y + p.y);
		}
		
		this.sub = function(p){
			return new Point(this.x - p.x, this.y - p.y);
		}
		
		this.mul = function(s){
			return new Point(this.x * s, this.y * s);
		}
		
		this.scale = function(s){
			return new Point((s / this.mag()) * this.x, (s / this.mag()) * this.y);
		}
		
		this.toString = function(){
			return x + ', ' + y;
		}
		
		this.equals = function(p){
			return (this.x == p.x) && (this.y == p.y);
		}
	}
	
	function Dot(pos){
		this.type = "Dot";
	
		this.pos = pos;
		
		this.tick = function(){
		
		}
		
		this.render = function(g){
			g.fillStyle = "#D0D000";
			g.fillRect(this.pos.x - 4, this.pos.y - 4, 8, 8);
		}
	}
	
	function Player(name, color, pos, speed, accel, lifespan){
		this.type = "Player";
		this.name = name;

		this.color = color;

		this.size = 15;
	
		this.pos = pos;
		this.vel = new Point(0, 0);
		this.acc = new Point(0, 0);
		
		this.speed = speed;
		this.accel = accel;
		this.lifespan = lifespan;
		this.life = 0;
		
		this.t = new Point(-1, -1);

		this.score = 0;
		
		this.tick = function(){
		
			if(!this.t.equals(new Point(-1, -1))){
			
				this.acc = ((this.t.sub(this.pos)).mul((this.speed + (this.pos.sub(this.t)).mag() / 100) / (this.t.sub(this.pos)).mag())).sub(this.vel);
			
				if(this.acc.mag() > this.accel){this.acc = this.acc.scale(this.accel)};
			}else{
				this.acc = new Point(0, 0);
			}
			
			this.vel = this.vel.add(this.acc);
			if(this.vel.mag() > 10){this.vel = this.vel.scale(10);}
			
			this.pos = this.pos.add(this.vel);
			if(this.pos.x < -100){this.pos.x = -100};
			if(this.pos.y < -100){this.pos.y = -100};
			if(this.pos.x > WIDTH + 100){this.pos.x = WIDTH + 100};
			if(this.pos.y > HEIGHT + 100){this.pos.y = HEIGHT + 100};
			
			this.life ++;
		}
		
		this.render = function(g){
			g.fillStyle = color;
			g.fillRect(this.pos.x - 7.5, this.pos.y - 7.5, this.size, this.size);
		}
	}
	
	////
    
	var WIDTH;
	var HEIGHT;
	
	var canvas = document.getElementById('draw');

	canvas.width = WIDTH = $(window).width();
	canvas.height = HEIGHT = $(window).height();

	// updates canvas when window is resized
	$(window).resize(function() {
	  	canvas.width = WIDTH = $(window).width();
		canvas.height = HEIGHT = $(window).height();
	});
		
	var g = canvas.getContext('2d');
	
	////
	
	var game = {};

	game.FPS = 50;

	// create gui object
	game.gui = new dat.GUI();

	game.gui.add(game,"FPS",1,100);
	
	game.ents = new ArrayList();
	
	game.run = function(){
		game.tick();
		game.render(g);

		// continue the game loop
		setTimeout(game.run, 1000 / game.FPS);
	}
	
	game.tick = function(){
		for (i = 0; i < game.ents.length; i++){
			var cur = game.ents.get(i);
			cur.tick();
			console.log();
			
			if(cur.type == "Player"){
			
				if(cur.life >= cur.lifespan){
					game.ents.remove(cur);
					game.gui.remove(cur.controller);
				};
				
				var mindis = 10000;
				cur.t = new Point(-1, -1);
			
				for(j = 0; j < game.ents.length; j++){
					var nex = game.ents.get(j);
					
					if(nex.type == "Dot"){
						
						
						if((nex.pos.sub(cur.pos)).mag() < mindis){
							cur.t = nex.pos;
							mindis = nex.pos.sub(cur.pos).mag();
						}
						
						if((nex.pos.sub(cur.pos)).mag() < 12){
							nex.pos = new Point(Math.random() * WIDTH, Math.random() * HEIGHT);
							cur.score ++;
							cur.life -= 50;
							
							if(cur.score > 2){
								var accel = cur.accel + 0.1 * (Math.pow((2 * Math.random()) - 1, 7));
								var speed = cur.speed + 4 * (Math.pow((2 * Math.random()) - 1, 7));

								var lifespan = cur.lifespan + 25 * (Math.pow((2 * Math.random()) - 1, 7));

								var player = new Player(cur.name, cur.color, cur.pos, speed, accel, cur.lifespan);

								// add gui control for size
								player.controller = game.gui.add(player,"size",1,20);

								game.ents.add(player);

								console.log("New Player created with accel: " + accel + " Speed: " + speed + " Lifespan: " + lifespan);
								cur.score = 0;
							}
						}
					}
					
					
				}
				
				
			}
		}
	}
	
	game.render = function(g){
		g.fillStyle = "#F0F0F0";
		g.fillRect(0, 0, WIDTH, HEIGHT);
		
		for (i = 0; i < game.ents.length; i++){
			game.ents.get(i).render(g);
		}
		
		game.ents.render(g);
	}
	
	////
	var d = new Date();

	// get current window dimensions
	var w = $(window).width();
	var h = $(window).height();
	
	// randomly positioned blood
	var position = new Point(getRandomInt(1, w), getRandomInt(1,h));
	var blood = new Player("Bloods", "#FF0000", position, 4, 0.2, 400);
	
	// add to game and gui control
	blood.controller = game.gui.add(blood,"size",1,20);
	game.ents.add(blood);

	// randomly positioned crip
	position = new Point(getRandomInt(1, w), getRandomInt(1,h));
	var crip = new Player("Cryps", "#0000FF", position, 2, 0.05, 1000);
	
	// add to game and gui control
	crip.controller = game.gui.add(crip,"size",1,20);
	game.ents.add(crip);


	game.ents.add(new Dot(new Point(getRandomInt(1, w), getRandomInt(1,h))));
	game.ents.add(new Dot(new Point(getRandomInt(1, w), getRandomInt(1,h))));
	game.ents.add(new Dot(new Point(getRandomInt(1, w), getRandomInt(1,h))));
	game.ents.add(new Dot(new Point(getRandomInt(1, w), getRandomInt(1,h))));
	game.ents.add(new Dot(new Point(getRandomInt(1, w), getRandomInt(1,h))));
	game.ents.add(new Dot(new Point(getRandomInt(1, w), getRandomInt(1,h))));
	
	////
	
	// start the game loop
	setTimeout(game.run, 1000 / game.FPS);
	
</script>

</html>